# Build and package validation workflow.
# Tests that the package can be built correctly as both source distribution and wheel.
# Validates package metadata, dependencies, and that the package is properly typed.

name: Build Tests
on:
  workflow_call:
  workflow_dispatch:  # to trigger manually

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        dist-type: [ "sdist", "wheel" ]
        package-extra: [ "", "all" ]

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Verify Build
        uses: durandtibo/verify-uv-build-action@v0.0.5a2
        with:
          package-name: objectory
          package-extra: ${{ matrix.package-extra }}
          package-dependencies: ""
          dist-type: ${{ matrix.dist-type }}

      - name: Run package checks
        shell: bash
        run: |
          set -euo pipefail
          echo "üîç Running package checks..."
          python tests/package_checks.py
          echo "‚úÖ Package checks passed"

  build2:
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        dist-type: [ "sdist" ]

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      # Step 2: Install uv package manager
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ inputs.python-version }}
          activate-environment: true

      # Step 3: Build the package
      - name: Build package
        shell: bash
        run: |
          set -euo pipefail
          echo "üì¶ Building package..."
          uv build
          echo "‚úÖ Build completed"

      - name: Show artifacts
        shell: bash
        if: always()
        run: |
          set -euo pipefail
          echo "üîç Show wheel content"
          unzip -l $(ls dist/*.whl | head -n1)
          echo ""
          echo "üîç Show sdist content"
          tar -tzf $(ls dist/*.tar.gz | head -n1)

      - name: Check for py.typed
        run: |
          set -euo pipefail
          echo "=== 1 ==="
          tar -tzf dist/objectory-0.3.1a0.tar.gz

          echo "=== 2 ==="
          tar -tzf dist/objectory-0.3.1a0.tar.gz 2>/dev/null | grep py.typed
          
          echo "=== 3 ==="
          tar -tzf dist/objectory-0.3.1a0.tar.gz 2>/dev/null | grep py.typed
          
          echo "=== 4 ==="
          tar -tzf dist/objectory-0.3.1a0.tar.gz 2>/dev/null | grep -q py.typed

          echo "=== 5 ==="
          if tar -tzf dist/objectory-0.3.1a0.tar.gz 2>/dev/null | grep -q py.typed; then
            echo "‚úÖ py.typed marker found"
          else
            echo "‚ùå Error: py.typed marker not found"
            exit 1
          fi

      # Step 5: Verify py.typed marker exists
      - name: Check py.typed in distribution
        shell: bash
        run: |
          set -euo pipefail
          COMMAND="tar -tzf $(ls dist/*.tar.gz | head -n1)"
          echo "$COMMAND"
          $COMMAND
          echo "=== END COMMAND ==="

          COMMAND="tar -tzf dist/objectory-0.3.1a0.tar.gz 2>/dev/null \| grep -q py.typed"
          echo "$COMMAND"
          $COMMAND
          echo "=== END COMMAND ==="

          if $COMMAND | grep -q py.typed; then
            echo "‚úÖ py.typed marker found"
          else
            echo "‚ùå Error: py.typed marker not found"
            exit 1
          fi
